name: build and test matrix multiplication

on:
    push:
        branches:
        - main
        - Luca
    pull_request:
        branches:
        - main
        - Luca

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
        - name: checkout repository
          uses: actions/checkout@v4
          with:
            submodules: recursive

        - name: set up environment
          run: |
            sudo apt-get update
            sudo apt-get install -y build-essential cmake mpich libmpich-dev

        - name: build project
          run: |
            mkdir build
            cd build
            cmake ..
            cmake --build .

        - name: run tests
          run: |
            cd build
            ctest --output-on-failure --output-log test_results.xml

        - name: upload test results
          if: failure()
          uses: actions/upload-artifact@v4
          with:
            name: test-results
            path: build/test_results.xml
         
        - name: Set up Go 1.13
          uses: actions/setup-go@v1
          with:
            go-version: 1.13
          id: go

        - name: Install Dependencies
          run: |
            sudo apt-get update && sudo apt-get install -y \
              build-essential \
              libssl-dev \
              uuid-dev \
              libgpgme11-dev \
              squashfs-tools \
              libseccomp-dev \
              pkg-config

        - name: Install Singularity
          env:
            SINGULARITY_VERSION: 4.1.3
            GOPATH: /tmp/go
        
          run: |
            mkdir -p $GOPATH
            sudo mkdir -p /usr/local/var/singularity/mnt && \
            mkdir -p $GOPATH/src/github.com/sylabs && \
            cd $GOPATH/src/github.com/sylabs && \
            wget -qO- https://github.com/sylabs/singularity/releases/download/v${SINGULARITY_VERSION}/singularity-ce-${SINGULARITY_VERSION}.tar.gz | \
            tar xzv && \
            cd singularity-ce-${SINGULARITY_VERSION} && \
            ./mconfig -p /usr/local && \
            make -C builddir && \
            sudo make -C builddir install          

        - name: Build Singularity Image
          run: |
            sudo apt-get update
            sudo singularity build matrix_multiplication.sif sweng_project2.def
            
        - name: Upload Artifact
          uses: actions/upload-artifact@v2
          with:
            name: matrix_multiplication
            path: matrix_multiplication.sif

        name: CI

