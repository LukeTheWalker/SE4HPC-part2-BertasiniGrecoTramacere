Bootstrap: docker
From: ubuntu:latest

%files
  . /project

%environment    
  export LD_LIBRARY_PATH=/usr/lib64/libibverbs:$LD_LIBRARY_PATH
  export LD_LIBRARY_PATH=/opt/ompi/lib:$LD_LIBRARY_PATH
  export PATH=/opt/ompi/bin:$PATH
  export DEBIAN_FRONTEND=noninteractive
  
  export OMPI_DIR=/opt/ompi
  export SINGULARITY_OMPI_DIR=$OMPI_DIR
  export SINGULARITYENV_APPEND_PATH=$OMPI_DIR/bin
  export SINGULAIRTYENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib


%post
  apt-get update
  apt-get install -y net-tools
  apt-get install -y libibverbs1
  apt-get install -y libibverbs-dev
  apt-get install -y ibverbs-utils
  apt-get install -y perftest
  apt-get install -y wget
  apt-get install -y gcc
  apt-get install -y g++
  apt-get install -y make
  apt-get install -y cmake
  sudo ln -s /usr/lib/apt/methods/gzip /usr/lib/apt/methods/bzip2
  sudo apt-get install bzip2


  echo "Installing required packages..."
  apt-get update && apt-get install -y wget git bash gcc gfortran g++ make file

  echo "Installing Open MPI"
  export OMPI_DIR=/opt/ompi
  export OMPI_VERSION=4.0.1
  export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-$OMPI_VERSION.tar.bz2"
  mkdir -p /tmp/ompi
  mkdir -p /opt
  # Download
  cd /tmp/ompi && wget -O openmpi-$OMPI_VERSION.tar.bz2 $OMPI_URL && tar -xjf openmpi-$OMPI_VERSION.tar.bz2
  # Compile and install
  cd /tmp/ompi/openmpi-$OMPI_VERSION && ./configure --prefix=$OMPI_DIR && make install
  
  cd /project
  mkdir -p build && cd build
  cmake ..
  cmake --build .
  cp /project/build/main /project