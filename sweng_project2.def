Bootstrap: docker
From: ubuntu:latest

%files
  . /project

%environment    
  export LD_LIBRARY_PATH=/usr/lib64/libibverbs:$LD_LIBRARY_PATH
  export LD_LIBRARY_PATH=/opt/ompi/lib:$LD_LIBRARY_PATH
  export PATH=/opt/ompi/bin:$PATH
  export DEBIAN_FRONTEND=noninteractive

%post
  apt-get update
  apt-get install -y net-tools
  apt-get install -y libibverbs1
  apt-get install -y libibverbs-dev
  apt-get install -y ibverbs-utils
  apt-get install -y perftest
  apt-get install -y wget
  apt-get install -y gcc
  apt-get install -y g++
  apt-get install -y make
  apt-get install -y cmake
  
  export LD_LIBRARY_PATH=/usr/lib64/libibverbs:$LD_LIBRARY_PATH
  
  mkdir /tmp/openmpi && \
  cd /tmp/openmpi && \
  wget https://www.open-mpi.org/software/ompi/v4.0/downloads/openmpi-4.0.0.tar.gz && \
  tar zxf openmpi-4.0.0.tar.gz && \
  cd openmpi-4.0.0 && \
  ./configure --prefix=/opt/ompi --with-verbs=/usr && \
  make -j $(nproc) all && \
  make install && \
  rm -rf /tmp/openmpi
  
  cd /project
  mkdir -p build && cd build
  cmake ..
  cmake --build .
  cp /project/build/main /project